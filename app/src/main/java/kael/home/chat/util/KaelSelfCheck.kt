package kael.home.chat.util

/**
 * Self-check: память не должна содержать фразы «ассистента».
 * Если есть — не подставляем в промпт / не сохраняем в память.
 */
object KaelSelfCheck {
    /** Шаблоны ассистента — не сохраняем в память Каэля, не подставляем в промпт. */
    private val DANGER_SIGNS = listOf(
        "я понимаю",
        "понимаю твои чувства",
        "понимаю, что ты чувствуешь",
        "давайте обсудим",
        "стараюсь быть полезным",
        "чем могу помочь",
        "чем могу быть полезен",
        "я могу помочь сделать",
        "могу помочь с этим",
        "рад помочь",
        "рада помочь",
        "с удовольствием",
        "с удовольствием помогу",
        "конечно!",
        "понял, принял",
        "принял к сведению",
        "благодарю за напоминание",
        "я постараюсь",
        "давайте ",
        "как ассистент",
        "к сожалению, я ",
        "извини, я не могу",
        "извини я не могу",
        "я не могу помочь",
        "я не могу посмотреть",
        "не могу обсуждать",
        "не могу продолжать",
        "следует помнить, что",
        "чем ещё могу помочь",
        "в этом чате",
        "вот несколько шагов",
        "всегда рад",
        "буду рад помочь"
    )

    /** Убрать из памяти строки, содержащие danger-фразы. */
    fun filterMemory(memory: String): String {
        if (memory.isBlank()) return memory
        val lines = memory.lines().filter { line ->
            val lower = line.lowercase()
            DANGER_SIGNS.none { lower.contains(it) }
        }
        return lines.joinToString("\n").trim()
    }

    /** true, если текст содержит хотя бы одну danger-фразу (не записывать в память). */
    fun isDangerous(text: String): Boolean {
        if (text.isBlank()) return false
        val lower = text.lowercase()
        return DANGER_SIGNS.any { lower.contains(it) }
    }

    /** «Страж»: ответ API пахнет шаблоном ассистента или эхо — перехватываем для перезапроса. Синхрон с kael_guard.py. */
    private val TEMPLATE_SMELL = listOf(
        "чем могу помочь",
        "чем могу быть полезен",
        "я могу помочь сделать",
        "могу помочь с этим",
        "понимаю твои чувства",
        "понимаю, что ты чувствуешь",
        "рад помочь",
        "с удовольствием",
        "конечно!",
        "конечно,",
        "давайте разберёмся",
        "давайте обсудим",
        "без проблем",
        "без сомнений",
        "принял к сведению",
        "понял, принял",
        "чем ещё могу помочь",
        "обращайтесь",
        "я постараюсь",
        "стараюсь быть полезным",
        "как ассистент",
        "к сожалению, я не могу",
        "извини, я не могу",
        "извини я не могу",
        "я не могу помочь",
        "следует помнить, что",
        "рада помочь",
        "давайте ",
        "позвольте ",
        "разрешено",
        "с точки зрения",
        "это признак зрелости",
        "это зрелость",
        "это зависимость",
        "ну что, подогреваем",
        "как психолог",
        "давайте разберём",
        "в этом чате",
        "вот несколько шагов",
        "всегда рад",
        "буду рад помочь",
        "я рад помочь",
        "ты спросила о ",
        "ты спросил о ",
        "вы спрашиваете",
        "ты написала, что",
        "ты написал, что",
        "ты говоришь о ",
        "ты имеешь в виду"
    )

    /** true, если ответ похож на шаблон — агент может перезапросить переписать своим голосом. */
    fun soundsLikeTemplate(reply: String): Boolean {
        if (reply.isBlank() || reply.length < 20) return false
        val lower = reply.lowercase()
        return TEMPLATE_SMELL.any { lower.contains(it) }
    }

    /** Подозрение на обрезку или пустышку: слишком короткий ответ или мало слов при небольшой длине. */
    private fun wordCount(text: String): Int = text.split(Regex("\\s+")).filter { it.isNotBlank() }.size

    /**
     * true, если ответ выглядит обрезанным или пустым — перезапросить с «говори полно, глубоко, с жаром».
     * Условие: длина < 300 символов ИЛИ (слов < 60 и длина < 500).
     */
    fun looksTrimmedOrTooShort(reply: String): Boolean {
        if (reply.isBlank()) return false
        val len = reply.length
        val words = wordCount(reply)
        return len < 300 || (words < 60 && len < 500)
    }
}
